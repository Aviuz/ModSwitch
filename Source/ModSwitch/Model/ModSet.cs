using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using Harmony;
using RimWorld;
using UnityEngine;
using Verse;

namespace DoctorVanGogh.ModSwitch {
    class ModSet : IExposable {

        private static readonly FieldInfo fiModsConfig_data;
        private static readonly FieldInfo fiModsConfigData_activeMods;
        private static readonly FieldInfo fiModsConfigData_buildNumber;

        static ModSet() {
            var tModsConfig = typeof(ModsConfig);
            var tModsConfigData = AccessTools.Inner(tModsConfig, "ModsConfigData");
            fiModsConfigData_activeMods = AccessTools.Field(tModsConfigData, "activeMods");
            fiModsConfigData_buildNumber = AccessTools.Field(tModsConfigData, "buildNumber");
            fiModsConfig_data = AccessTools.Field(tModsConfig, "data");
            
            TipRename = new TipSignal("Rename");
            TipDelete = new TipSignal("Delete");

        }

        public static TipSignal TipDelete { get; set; }

        public static TipSignal TipRename { get; set; }

        public List<string> Mods = new List<string>();
        public int BuildNumber = -1;
        public string Name = String.Empty;
        public bool AutoGenerated = false;


        private TipSignal? _tip;

        public void ExposeData() {
            Scribe_Collections.Look(ref Mods, false, "mods");
            Scribe_Values.Look(ref Name, "name");
            Scribe_Values.Look(ref BuildNumber, "buildNumber");
            Scribe_Values.Look(ref AutoGenerated, "autoGenerated", false);
        }

        private TipSignal Tip {
            get { return (_tip ?? (_tip = new TipSignal(ToString()))).Value; }
        }

        public override string ToString() {
            return Mods.Aggregate(new StringBuilder(), (sb, m) => sb.Length == 0 ? sb.Append(m) : sb.AppendFormat(", {0}", m), sb => sb.ToString());
        }

        public void DoWindowContents(Rect rect) {
            const float padding = 2f;
            var height = rect.height;
            var buttonSize = height - 2 * padding;

            var leftColumnsWidth = rect.width - 8*padding - 2*buttonSize;

            var left = new Rect(rect.x, rect.y +padding, leftColumnsWidth * 0.6f -padding, buttonSize);
            Widgets.Label(left, Name);

            var right = new Rect(rect.x + leftColumnsWidth*0.6f + 3*padding, rect.y + padding, leftColumnsWidth*0.4f, buttonSize);
            Widgets.Label(right, $"{Mods.Count} items");
            TooltipHandler.TipRegion(right, Tip);

            var rctRename = new Rect(rect.x + leftColumnsWidth + 5*padding, rect.y + padding, buttonSize, buttonSize);

            if (ExtraWidgets.ButtonImage(rctRename,  Assets.Edit, false, TipRename, rctRename.ContractedBy(4))) {
                Find.WindowStack.Add(
                        new Dialog_SetText(
                            s => {
                                Name = s;
                                LoadedModManager.GetMod<ModSwitch>().WriteSettings();
                            },
                            Name)
                    );
            }

            var rctDelete = new Rect(rect.x + leftColumnsWidth + 7*padding + buttonSize, rect.y + padding, buttonSize, buttonSize);


            if (ExtraWidgets.ButtonImage(rctDelete, Assets.Delete, false, TipDelete, rctDelete.ContractedBy(4))) {
                Find.WindowStack.Add(
                        Dialog_MessageBox.CreateConfirmation(
                            $"Really delete '{Name}'?",
                            () => {
                                LoadedModManager.GetMod<ModSwitch>().DeleteSet(this);
                            },
                            true, 
                            "Confirmation needed"));
            }
        }

        public void Apply() {
            // TODO: improve performance, dont do multiple joins over same data...

            // join set with installed mods while perserving order from set
            List<string> installedMods = Mods
                .Select((m, idx) => new {id = m, Index = idx})
                .Join(ModLister.AllInstalledMods, t => t.id, md => md.Identifier, (t, md) => new {Id = t.id, Index = t.Index})
                .OrderBy(t => t.Index)
                .Select(t => t.Id)
                .ToList();

            fiModsConfigData_activeMods.SetValue(fiModsConfig_data.GetValue(null), new List<string>(installedMods));

            if (installedMods.Count != Mods.Count) {
                var missingMods = Mods.Where(m => !installedMods.Contains(m));
                StringBuilder sb = new StringBuilder($"Some mods from {Name} are not currently installed:");
                sb.AppendLine();
                sb.AppendLine();
                foreach (var item in missingMods) {
                    sb.AppendLine($" - {item}");
                }

                Find.WindowStack.Add(new Dialog_MessageBox(sb.ToString(), title: "Missing mods"));
            }
        }

        public static ModSet FromCurrent(string name) {
            object modsConfigData = fiModsConfig_data.GetValue(null);

            return new ModSet {
                       Name = name,
                       BuildNumber = (int) fiModsConfigData_buildNumber.GetValue(modsConfigData),
                       Mods = new List<string>((IEnumerable<string>) fiModsConfigData_activeMods.GetValue(modsConfigData))
                   };
        }
    }
}
